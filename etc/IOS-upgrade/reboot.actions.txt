[Define]
old_verify  = ${caller.old_verify}
new_verify  = ${caller.new_verify}

new_file    = ${caller.new_file}
have_image_file  = ${caller.have_image_file}
valid_image = ${caller.valid_image}

rom_file    = ${caller.rom_file}
have_rom_file  = ${caller.have_rom_file}
valid_rom   = ${caller.valid_rom}

# Is an upgrade needed ?
[If FromVariable=valid_image]
1
    [If FromVariable=valid_rom]
    1
        [If FromVariable=rom_file]
        ${}
            [Error]
            Already running Image ${new_file}
        [Else]
            [Error]
            Already running Image ${new_file} and ROM ${rom_file}
        [EndIf]
    [EndIf]
[EndIf]

[If Not,FromVariable=have_image_file]
1

    [Error]
    Image File ${new_file} is not in flash. Please run the pre upgrade script (IOS-upgrade.pre) first
[EndIf]

[If Not,FromVariable=have_rom_file]
1

    [Error]
    ROM File ${rom_file} is not in flash. Please run the pre upgrade script (IOS-upgrade.pre) first
[EndIf]

[If Not,FromVariable=valid_image]
1
    [If Not,FromVariable=old_verify]
    0
        # If we are only doing a ROM upgrade the old IOS is the same as the new
        # So no need for what is then the same verify
        [If Not,FromVariable=new_file]
        ${caller.old_file}
            # Also verify the old image since we might want to roll back
            [Include File=verify.actions.txt]
            argument: file    = ${caller.filesystem}:${caller.old_file}
            argument: md5     =
            argument: context = Verify failure for old image
        [EndIf]
    [EndIf]
[EndIf]

[If Not,FromVariable=new_verify]
0
    # Verify the new image
    [Include File=verify.actions.txt]
    argument: file    = ${caller.filesystem}:${new_file}
    argument: md5     = ${caller.new_md5}
    argument: context = Verify failure for new image

    [If Not,FromVariable=valid_rom]
    1
        [If Not,FromVariable=rom_file]
        ${}
            # Verify the new ROM
            [Include File=verify.actions.txt]
            argument: file    = ${caller.filesystem}:${rom_file}
            argument: md5     = ${caller.rom_md5}
            argument: context = Verify failure for new ROM
        [EndIf]
    [EndIf]
[EndIf]

[Commands Single=True]
copy run ${caller.filesystem}:config_${global.job_utc:%Y-%m-%dT%H:%M:%SZ}
${}
${}

[If Not,FromVariable=valid_rom]
1
    [Commands]
    upgrade rom-monitor filename ${caller.filesystem}:${caller.rom_file} all
[EndIf]

[Configure]
no boot system
boot system ${caller.filesystem}:${new_file}
boot system ${caller.filesystem}

[Apply]

# pre.actions.txt already do a verify
[Commands Single=True, Disconnect=True]
reload /noverify
${}
${}
