#!/opt/Shell/tooling/device-apply/bin/device-apply -A

# Upload a new image

[Include File=IOS.actions.txt]
define: debug
define: verify
define: ftp
define: filesystem

define: old_file
define: new_file
define: new_md5
define: have_image_file
define: valid_image

define: rom_file
define: rom_md5
define: have_rom_file
define: valid_rom

# Load FTP credentials
[Define BodyFromFile=$CURRENT_DIR/jumpserver.ftp.gpg, Secret=False, Prefix=ftp_]

# Hide FTP password in logs
[Secret]
${ftp_Password}

# If ftp_server is unset replace it by the local IP address
# (so this will become the local jumpserver IP)
[If FromVariable=ftp_Server]
0.0.0.0
  [Assign]
  ftp_Server = ${global.device_local_ip}
[EndIf]

[If Not,FromVariable=debug]
0
  [Print]
  FTP:
    me = ftpuser
    user = ${ftp_User}
    pass = ${ftp_Password}
    host = ${ftp_Server}
    path = ${ftp_Path}
[EndIf]

[Scope]
    [If Not,FromVariable=have_image_file]
    1
      [If FromVariable=ftp]
      0
        [Error]
        Need to fetch IOS image ${filesystem}:${new_file} but ftp=${ftp} (not 1)
      [Else]
        [Commands Single]
        copy ftp://${ftp_User}:${ftp_Password}@${ftp_Server}${ftp_Path}${new_file} ${filesystem}:${new_file}
        # Press enter 3 times to confirm user/pass/path
        ${}
        ${}
        ${}
        ${}
      [EndIf]
    [EndIf]
    
    [If Not,FromVariable=verify]
    0
        # Verify image
        [Include File=verify.actions.txt]
        argument: file    = ${filesystem}:${new_file}
        argument: md5     = ${new_md5}
        argument: context = Image verify failure
    [EndIf]
[EndScope]

[If Not,FromVariable=valid_rom]
1
    [If Not,FromVariable=have_rom_file]
    1
      [If FromVariable=ftp]
      0
        [Error]
        Need to fetch ROM ${filesystem}:${rom_file} but ftp=${ftp} (not 1)
      [Else]
        [Commands Single]
        copy ftp://${ftp_User}:${ftp_Password}@${ftp_Server}${ftp_Path}${rom_file} ${filesystem}:${rom_file}
        # Press enter 3 times to confirm user/pass/path
        ${}
        ${}
        ${}
        ${}
      [EndIf]
    [EndIf]
    
    [If Not,FromVariable=verify]
    0
        # Verify image
        [Include File=verify.actions.txt]
        argument: file    = ${filesystem}:${rom_file}
        argument: md5     = ${rom_md5}
        argument: context = ROM verify failure
    [EndIf]
[EndIf]

[Return]
verify       = ${verify}
debug        = ${debug}
filesystem   = ${filesystem}

old_file     = ${old_file}
new_file     = ${new_file}
new_md5      = ${new_md5}
valid_image  = ${valid_image}

rom_file     = ${rom_file}
rom_md5      = ${rom_md5}
valid_rom    = ${valid_rom}
