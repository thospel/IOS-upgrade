#!/opt/Shell/tooling/device-apply/bin/device-apply -A

# Upload a new image

[Define]
ftp=1

[Include File=IOS.actions.txt]
define: debug
define: verify
define: filesystem
define: old_file
define: new_file
define: have_file

# Load FTP credentials
[Define BodyFromFile=$CURRENT_DIR/jumpserver.ftp.gpg, Secret=False, Prefix=ftp_]

# Hide FTP password in logs
[Secret]
${ftp_Password}

# If ftp_server is unset replace it by the local IP address
# (so this will become the local jumpserver IP)
[If FromVariable=ftp_Server]
0.0.0.0
  [Assign]
  ftp_Server = ${global.device_local_ip}
[EndIf]

[If Not,FromVariable=debug]
0
  [Print]
  FTP:
    me = ftpuser
    user = ${ftp_User}
    pass = ${ftp_Password}
    host = ${ftp_Server}
    path = ${ftp_Path}
[EndIf]

[If Not,FromVariable=have_file]
1
  [If FromVariable=ftp]
  0
    [Error]
    Need to fetch ${filesystem}:${new_file}
  [Else]
    [Commands Single]
    copy ftp://${ftp_User}:${ftp_Password}@${ftp_Server}${ftp_Path}${new_file} ${filesystem}:${new_file}
    # Press enter 3 times to confirm user/pass/path
    ${}
    ${}
    ${}
    ${}
  [EndIf]
[EndIf]

[If Not,FromVariable=verify]
0
    # Verify image
    [Include File=verify.actions.txt]
    argument: file    = ${filesystem}:${new_file}
    argument: context = Verify failure
[EndIf]

[Return]
verify       = ${verify}
debug        = ${debug}
filesystem   = ${filesystem}
old_file     = ${old_file}
new_file     = ${new_file}
have_file    = ${have_file}
